# no thin-provisionning
sudo pvcreate /dev/sdb1
sudo vgcreate vg /dev/sdb1
sudo lvcreate -n lv0 -l 100%FREE vg
sudo mkfs -t ext4 -L MAILSERVER /dev/vg/lv0


# with thin-provisionning (recommended)
sudo apt-get install thin-provisioning-tools
sudo pvcreate /dev/sdb
sudo vgcreate vg /dev/sdb
sudo lvcreate -l 100%FREE -T vg/thinpool -V100G -n lv0 --errorwhenfull y
sudo mkfs -t ext4 -L MAILSERVER -E nodiscard /dev/vg/lv0


# automatic resize (not used in our case)
sudo apt-get install thin-provisioning-tools
sudo vi /etc/lvm/lvm.conf
        thin_pool_autoextend_threshold = 70
	thin_pool_autoextend_percent = 20
sudo pvcreate /dev/sdb1
sudo vgcreate vg /dev/sdb1
sudo lvcreate -L 5G -T vg/thinpool -V100G -n lv0
sudo mkfs -t ext4 -L MAILSERVER -E nodiscard /dev/vg/lv0


# mount
sudo mkdir -p /mnt/mailserver
echo 'LABEL=MAILSERVER	/mnt/mailserver	ext4	defaults	0 2' >> /etc/fstab
sudo mount /mnt/mailserver


# installing local-persist (in order to specify mountpoints for volumes)
curl -fsSL https://raw.githubusercontent.com/MatchbookLab/local-persist/master/scripts/install.sh | sudo bash



#TODO: notify when thinpool reach X%, in order to extend the blockdevice

#disabling
sudo umount /mnt/mailserver
sudo vgchange -an vg
sudo vgexport vg
### TODO OVH/Openstack API call to extend
#re-enabling
(sudo pvscan)
sudo vgimport vg
sudo pvresize /dev/sdb
sudo lvextend -l +100%FREE vg/thinpool
sudo vgchange -ay vg
sudo mount /mnt/mailserver








BENCH

sudo apt install fio
sudo fio --randrepeat=1 --ioengine=libaio --direct=1 --gtod_reduce=1 --name=test --filename=random_read_write.fio --bs=4k --iodepth=64 --size=1G --readwrite=randrw --rwmixread=75


FAQ

Q: `pvcreate`command returns 'Device /dev/sdx excluded by a filter' error.
A: Run with -vvv to get more details. In my case: 
        /dev/sdc: Skipping: Partition table signature found
   We understand the device was previously partionned. Fix by wiping data: `sudo dd if=/dev/zero of=/dev/sdc bs=1M count=1`
